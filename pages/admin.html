<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Book Slot Machine</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/styles.css" rel="stylesheet">
  <!-- Favicons -->
  <link rel="icon" href="../favicon/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png" />
  <link rel="manifest" href="../favicon/site.webmanifest" />
  <meta name="theme-color" content="#ffffff">
  <style>
    /* Site-wide nav styles copied from index.html for consistent header */
    .site-nav { text-align:center; margin: 1rem 0; }
    .site-nav a {
      display: inline-block;
      margin: 0.6rem 1rem;
      padding: 0.6rem 1.2rem;
      background: #f6f6f6;
      color: #333;
      border-radius: 10px;
      text-decoration: none;
      border: 1px solid #ddd;
      font-size: 1rem;
      transition: background 0.2s, color 0.2s;
    }
    .site-nav a:hover { background: #aee; color: #105; }
    .site-nav a.active { background:#ffc107; color:#111; border-color:#e0a800; }
  /* Lightweight custom modal for spin confirmation */
  /* Scroll-lock body while modal is open */
  body.modal-open { overflow: hidden; height: 100vh; touch-action: none; }
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.46); display: flex; align-items: center; justify-content: center; z-index: 1050; padding: 12px; }
  .modal-card { background: #fff; border-radius: 10px; max-width: 520px; width: 100%; padding: 14px 16px; box-shadow: 0 12px 36px rgba(0,0,0,0.28); border: 1px solid rgba(0,0,0,0.06); transform: translateY(8px); opacity: 0; transition: transform .18s ease, opacity .18s ease; }
  .modal-overlay.show .modal-card { transform: translateY(0); opacity: 1; }
  .modal-card h3 { margin: 0 0 6px 0; font-size: 1rem; font-weight:600; }
  .modal-card p { margin: 0; color: #222; font-size: 0.96rem; line-height:1.35; }
  .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
  /* larger touch targets */
  .modal-actions .btn { min-width: 96px; padding: 10px 14px; font-size: 1rem; border-radius: 8px; }
  .modal-actions .btn.btn-primary { background:#0b5ed7; border-color:#0a58ca; color:#fff; }
  .modal-actions .btn.btn-outline-secondary { color:#333; border-color:rgba(0,0,0,0.12); }
  @media (max-width:420px){ .modal-actions { flex-direction: column-reverse; } .modal-actions .btn{ width:100%; } }
  .modal-overlay.d-none { display: none; }
  /* Custom styled dropdown for Edit Choice panels to match site look */
  .edit-choice-panel { position: relative; }
  .edit-choice-datalist { display: none !important; } /* hide native datalist UI in favor of styled list */
  .edit-choice-results {
    position: absolute;
    left: 0;
    right: 0;
    z-index: 2050;
    margin-top: 6px;
    max-height: 220px;
    overflow: auto;
    border: 1px solid rgba(0,0,0,0.08);
    background: #fff;
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    border-radius: 8px;
  }
  .edit-choice-results .list-group-item{ cursor: pointer; padding: 8px 10px; font-size: 0.95rem; }
  .edit-choice-results .list-group-item:hover{ background:#f1f7fb; }
  </style>
</head>
<body>
  <header style="text-align:center; margin:1rem 0;">
  <a href="../index.html" class="btn btn-secondary">üè† Main Page</a>
  </header>
  <div class="container">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h1 class="h4">Admin: Book Slot Machine</h1>
        <p class="small text-muted">This page is for the club lead to control the SPIN / RESET actions for choosing next month's book. Only one person should be in control at a time.</p>
  <div id="admin-msg" class="mt-2"><small id="qr-status" class="text-muted"></small></div>
        <div class="mt-3">
          <a href="voting.html" class="btn btn-secondary me-2">Member View</a>
          <a href="voting_poll.html" class="btn btn-info">Open Voting Poll</a>
        </div>
        <!-- Member View share panel (lead can share this with members) -->
        <div id="member-share" class="mt-3 d-none">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6">Share: Member View</h2>
              <p class="small text-muted">Share this link or QR code with group members so they can open the Member View.</p>
              <div class="d-flex gap-3 align-items-center">
                <div class="qr-wrap-member" style="width:120px;flex:0 0 120px;">
                  <img id="member-qr" src="" alt="Member View QR" style="width:120px;height:120px;border:1px solid #e6e6e6;border-radius:8px;background:#fff;padding:6px;" />
                </div>
                <div class="flex-grow-1">
                  <p class="mb-2"><strong>Member view URL</strong></p>
                  <div class="d-flex gap-2 align-items-center">
                    <input id="memberLink" type="text" class="form-control" value="https://paulbenson88.github.io/Book-Club/pages/voting.html" />
                    <button id="copyMemberLink" class="btn btn-outline-primary">Copy link</button>
                    <a id="openMember" href="voting.html" class="btn btn-secondary">Open Member View</a>
                  </div>
                  <div id="copyMemberFeedback" class="small text-success mt-2" style="display:none;">Link copied to clipboard</div>
                  <div id="member-hint" class="small text-muted mt-2" style="display:none;">Use an https:// URL for QR scanners to open the page directly.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <div id="slot-area">
  <div class="alert alert-info small">Admin controls: anyone on this page may operate the slot machine.</div>
      <div id="slot-host" class="mt-3">
          <div id="slot-container" class="d-none">
            <div class="slot-machine-frame">
          <div class="slot-machine-title">BOOK SLOT MACHINE</div>
          <div class="d-flex justify-content-center my-3"><button id="slotSpinBtn" class="btn spin-center-btn">SPIN</button></div>
          <div class="slot-reels">
            <div class="slot-reel" id="slot1">
              <div class="slot-scroll" id="slotScroll1"><div class="slot-scroll-list"></div></div>
              <button id="slotStopBtn1" class="btn stop-btn mt-2" disabled>Stop</button>
              <button class="btn reel-respin mt-2 d-none" data-reel="0" disabled>‚ü≤ Respin</button>
              <button class="btn btn-outline-secondary edit-choice mt-2 d-none" data-reel="0">Edit Choice</button>
              <div class="edit-choice-panel mt-2 d-none" data-reel="0">
                <input type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="form-control edit-choice-input" placeholder="Search or choose a book..." aria-label="Search or choose a book" />
                <datalist id="edit-choice-list-0" class="edit-choice-datalist"></datalist>
                <div class="edit-choice-results list-group d-none" aria-hidden="true"></div>
                <div class="small text-muted mt-1">Select a book to replace this reel.</div>
              </div>
               <div class="suggested-by text-muted small mt-1 text-center">Suggested by: <span id="suggested1-name"></span></div>
            </div>
            <div class="slot-reel" id="slot2">
              <div class="slot-scroll" id="slotScroll2"><div class="slot-scroll-list"></div></div>
              <button id="slotStopBtn2" class="btn stop-btn mt-2" disabled>Stop</button>
              <button class="btn reel-respin mt-2 d-none" data-reel="1" disabled>‚ü≤ Respin</button>
              <button class="btn btn-outline-secondary edit-choice mt-2 d-none" data-reel="1">Edit Choice</button>
              <div class="edit-choice-panel mt-2 d-none" data-reel="1">
                <input type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="form-control edit-choice-input" placeholder="Search or choose a book..." aria-label="Search or choose a book" />
                <datalist id="edit-choice-list-1" class="edit-choice-datalist"></datalist>
                <div class="edit-choice-results list-group d-none" aria-hidden="true"></div>
                <div class="small text-muted mt-1">Select a book to replace this reel.</div>
              </div>
              <div class="suggested-by text-muted small mt-1 text-center">Suggested by: <span id="suggested2-name"></span></div>
            </div>
            <div class="slot-reel" id="slot3">
              <div class="slot-scroll" id="slotScroll3"><div class="slot-scroll-list"></div></div>
              <button id="slotStopBtn3" class="btn stop-btn mt-2" disabled>Stop</button>
              <button class="btn reel-respin mt-2 d-none" data-reel="2" disabled>‚ü≤ Respin</button>
              <button class="btn btn-outline-secondary edit-choice mt-2 d-none" data-reel="2">Edit Choice</button>
              <div class="edit-choice-panel mt-2 d-none" data-reel="2">
                <input type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="form-control edit-choice-input" placeholder="Search or choose a book..." aria-label="Search or choose a book" />
                <datalist id="edit-choice-list-2" class="edit-choice-datalist"></datalist>
                <div class="edit-choice-results list-group d-none" aria-hidden="true"></div>
                <div class="small text-muted mt-1">Select a book to replace this reel.</div>
              </div>
              <div class="suggested-by text-muted small mt-1 text-center">Suggested by: <span id="suggested3-name"></span></div>
            </div>
          </div>
          <div id="slotResult" class="slot-result"></div>
          <div id="slotLoading" class="text-muted text-center mt-2 small">Loading book list...</div>
          
        </div>
            <!-- Voting poll share panel (hidden until winners present) -->
            <div id="poll-share" class="mt-4 d-none">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h2 class="h5">Go to Voting Poll</h2>
                  <p class="small text-muted">Once all three books have been chosen, click the button below to open the voting poll. Share the QR code or copy the poll link to invite members to vote.</p>
                  <div class="d-flex gap-3 align-items-center">
                    <div class="qr-wrap" style="width:120px;flex:0 0 120px;">
                      <img id="poll-qr" src="" alt="Voting Poll QR" style="width:120px;height:120px;border:1px solid #e6e6e6;border-radius:8px;background:#fff;padding:6px;" />
                    </div>
                    <div class="flex-grow-1">
                      <p class="mb-2"><strong>Voting poll URL</strong></p>
                      <div class="d-flex gap-2 align-items-center">
                        <input id="pollLink" type="text" class="form-control" value="https://paulbenson88.github.io/Book-Club/pages/voting_poll.html" />
                        <button id="copyPollLink" class="btn btn-outline-primary">Copy link</button>
                        <a id="openPoll" href="voting_poll.html" class="btn btn-primary">Open Poll</a>
                      </div>
                      <div id="copyFeedback" class="small text-success mt-2" style="display:none;">Link copied to clipboard</div>
                      <div id="poll-hint" class="small text-muted mt-2" style="display:none;">Scanners often cannot open file:// or plain filenames‚Äîpaste a public https:// URL above for a working QR.</div>
                      <p class="small text-muted mt-2 mb-0">Share this QR code or the link via text or social channels.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
              <!-- Manual winners fallback (lead can paste titles/authors) -->
              
                <!-- Admin poll controls (fail-safe) -->
                <div id="admin-poll-controls" class="mt-3 d-none">
                  <div class="card shadow-sm">
                    <div class="card-body">
                      <h2 class="h6">Admin: Poll controls (fail-safe)</h2>
                      <p class="small text-muted">If the poll UI or syncing breaks, you can clear all votes here or add votes manually on behalf of a member. Use these sparingly ‚Äî they're intended as emergency tools.</p>
                      <div class="mb-2">
                        <button id="clear-all-votes" class="btn btn-outline-danger">Clear all votes from poll</button>
                        <span id="clear-votes-feedback" class="small text-success ms-2" style="display:none;">Votes cleared</span>
                      </div>
                      <hr />
                      <div class="row g-2 align-items-center">
                        <div class="col-12 col-md-6">
                          <input id="admin-voter-name" class="form-control" placeholder="Name to add votes for (e.g. Merc)" />
                        </div>
                        <div class="col-12 col-md-6">
                          <div id="admin-poll-books" class="d-flex gap-2 flex-wrap"></div>
                        </div>
                        <div class="col-12">
                          <div class="d-flex gap-2 mt-2">
                            <button id="admin-add-votes" class="btn btn-primary">Add votes for selected books</button>
                            <button id="admin-remove-votes" class="btn btn-warning">Remove votes for selected books</button>
                            <button id="admin-refresh-books" class="btn btn-outline-secondary">Refresh book list</button>
                          </div>
                          <div id="admin-add-feedback" class="small text-success mt-2" style="display:none;">Votes added</div>
                          <div id="admin-add-warning" class="small text-muted mt-1">Tip: this only updates the poll's local votes storage; open poll tab will reflect changes automatically.</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
      </div>
    </div>
  </div>

  <script src="../js/qrcode.min.js"></script>
  <!-- Firebase SDK (placeholder) -->
  <!--
    To enable Firestore publishing:
    1) Create a Firebase project at https://console.firebase.google.com/
    2) Add a Web app and copy the config below into the firebaseConfig object.
    3) Enable Firestore in the console and add rules that allow writes from an authenticated admin only.
    4) Replace the placeholder values below.
  -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <!-- Slot confirmation modal (shown before Spin or Reset) -->
  <div id="slotConfirmModal" class="modal-overlay d-none" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="slotConfirmTitle">
      <h3 id="slotConfirmTitle">Confirm slot operation</h3>
      <p id="slotConfirmMessage">Only proceed if you're the designated spinner ‚Äî this will overwrite someone else's results.</p>
      <div class="modal-actions">
        <button id="slotConfirmCancel" class="btn btn-outline-secondary">Cancel</button>
        <button id="slotConfirmOk" class="btn btn-primary">Proceed</button>
      </div>
    </div>
  </div>
  <!-- Start Poll preview modal (moved out of script) -->
  <div id="startPollModal" class="modal-overlay d-none" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="startPollTitle">
      <h3 id="startPollTitle">Preview poll choices</h3>
      <div id="startPollList" style="margin-top:8px;"></div>
      <div class="modal-actions">
        <button id="startPollCancel" class="btn btn-outline-secondary">Cancel</button>
        <button id="startPollConfirm" class="btn btn-success">Publish Poll</button>
      </div>
    </div>
  </div>
  <script>
    (function(){
      const msg = document.getElementById('admin-msg');
      const host = document.getElementById('slot-host');

  // Reveal slot UI for any visitor and load voting script
  try{ const cont = document.getElementById('slot-container'); if(cont) cont.classList.remove('d-none'); }catch(e){}
  try{ loadVotingScript(); }catch(e){}

        function loadVotingScript(){
        if(document.querySelector('script[data-voting-loaded]')) return;
        const s = document.createElement('script'); s.src = '../js/voting.js'; s.setAttribute('data-voting-loaded','1'); document.body.appendChild(s);
      }

  // Manual winners UI removed ‚Äî manual save/clear handlers cleaned up.
    })();
    // QR + copy-link handling for voting poll (use local QR lib, show panel only when winners present)
    (function(){
  const pollUrl = 'https://paulbenson88.github.io/Book-Club/pages/voting_poll.html';
      // expose canonical poll url for other scripts
      try{ window.adminPollUrl = pollUrl; }catch(e){}
      const linkInput = document.getElementById('pollLink');
      const copyBtn = document.getElementById('copyPollLink');
      const openBtn = document.getElementById('openPoll');
      const feedback = document.getElementById('copyFeedback');
      const pollShare = document.getElementById('poll-share');

      function showSharePanel(){
        // ensure poll-share is visible
        try{ if(pollShare){ pollShare.classList.remove('d-none'); pollShare.style.display='block'; } }catch(e){}
  renderQR();
  // schedule a follow-up render in case QR lib wasn't ready yet
  setTimeout(()=>{ try{ renderQR(); }catch(e){ } },300);
      }

      function renderQR(url){
        try{
          const u = url || (linkInput && linkInput.value) || pollUrl;
          console.log('[admin] renderQR called, url=', u);
          // Render as a simple <img> pointing to the qrserver API (matches old voting.html)
          const wrap = document.querySelector('.qr-wrap');
          const statusEl = document.getElementById('qr-status');
          let img = document.getElementById('poll-qr');
          if(!img){ if(wrap){ img = document.createElement('img'); img.className = 'qr'; img.id='poll-qr'; img.alt='QR code for voting poll'; img.style.width='120px'; img.style.height='120px'; img.style.border='1px solid #e6e6e6'; img.style.borderRadius='8px'; img.style.background='#fff'; img.style.padding='6px'; wrap.innerHTML=''; wrap.appendChild(img); } }
          if(img){
            // encode the absolute URL so phones open the page instead of searching for a filename
            const qrData = encodeURIComponent(u);
            img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=' + qrData;
          }
          if(linkInput) linkInput.value = u;
          if(openBtn) openBtn.href = u;
          console.log('[admin] renderQR finished');
          const hint = document.getElementById('poll-hint');
          if(hint) hint.style.display = (/^https?:\/\//i.test(u) ? 'none' : 'block');
        }catch(e){ console.warn('QR render failed',e); }
      }

      // expose helpers so other handlers can trigger showing/re-rendering
  window.showAdminPollShare = showSharePanel;
  window.renderAdminPollQR = renderQR;

      if(copyBtn){ copyBtn.addEventListener('click', async ()=>{
        try{
          const toCopy = (linkInput && linkInput.value) || pollUrl;
          await navigator.clipboard.writeText(toCopy);
          if(feedback){ feedback.style.display='block'; setTimeout(()=>feedback.style.display='none',2000); }
        }catch(err){ try{ linkInput.select(); }catch(e){} }
      }); }

  // Re-render when admin edits the poll link input
  if(linkInput){ linkInput.addEventListener('change', ()=>{ try{ renderQR(linkInput.value); }catch(e){} }); }

      // Show share panel only if there are winners saved
      try{
        const winners = JSON.parse(localStorage.getItem('winners') || 'null');
        if(Array.isArray(winners) && winners.length>=3){ showSharePanel(); }
      }catch(e){ /* ignore */ }

  // Start Poll flow removed ‚Äî publishing handled elsewhere or not used in this build.

      // Listen for storage events so panel appears when winners are saved in another tab
      window.addEventListener('storage', (ev)=>{
        if(ev.key==='winners' && ev.newValue){
          try{ const w = JSON.parse(ev.newValue); if(Array.isArray(w) && w.length>=3) showSharePanel(); }catch(e){}
        }
      });
  // Also listen for same-window custom events from the slot script
  window.addEventListener('winnersSaved',(ev)=>{ try{ const w = ev.detail; if(Array.isArray(w) && w.length>=3) showSharePanel(); }catch(e){} });
  window.addEventListener('winnersCleared', ()=>{ try{ if(pollShare) pollShare.classList.add('d-none'); }catch(e){} });
      // ensure QR image has a src on load so the img doesn't show alt text
      try{ renderQR(); }catch(e){}
    })();

    // Member view share handling (top panel)
    (function(){
  const memberUrl = 'https://paulbenson88.github.io/Book-Club/pages/voting.html';
      const memberInput = document.getElementById('memberLink');
      const copyMemberBtn = document.getElementById('copyMemberLink');
      const openMemberBtn = document.getElementById('openMember');
      const memberShare = document.getElementById('member-share');
      const memberFeedback = document.getElementById('copyMemberFeedback');

      function showMemberPanel(){ try{ if(memberShare){ memberShare.classList.remove('d-none'); memberShare.style.display='block'; } }catch(e){}
      }

      function renderMemberQR(url){
        try{
          const u = url || (memberInput && memberInput.value) || memberUrl;
          const wrap = document.querySelector('.qr-wrap-member');
          let img = document.getElementById('member-qr');
          if(img){
            const qrData = encodeURIComponent(u);
            img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=' + qrData;
          }
          if(memberInput) memberInput.value = u;
          if(openMemberBtn) openMemberBtn.href = u;
          const hint = document.getElementById('member-hint'); if(hint) hint.style.display = (/^https?:\/\//i.test(u) ? 'none' : 'block');
        }catch(e){ console.warn('renderMemberQR failed', e); }
      }

      window.showAdminMemberShare = showMemberPanel;

      if(copyMemberBtn){ copyMemberBtn.addEventListener('click', async ()=>{
        try{ const toCopy = (memberInput && memberInput.value) || memberUrl; await navigator.clipboard.writeText(toCopy); if(memberFeedback){ memberFeedback.style.display='block'; setTimeout(()=>memberFeedback.style.display='none',2000); } }catch(err){ try{ memberInput.select(); }catch(e){} }
      }); }

      if(memberInput){ memberInput.addEventListener('change', ()=>{ try{ renderMemberQR(memberInput.value); }catch(e){} }); }

      // Show member panel if leader or always render small QR on load
      try{ const winners = JSON.parse(localStorage.getItem('winners') || 'null'); if(sessionStorage.getItem('isLead')) showMemberPanel(); }catch(e){}
      try{ renderMemberQR(); }catch(e){}
    })();

    // End lead session button handler
    (function(){
  // ensure admin controls are visible and populated immediately
  try{ renderAdminBookList(); showAdminPollControls(); }catch(e){}
    })();

    // Admin poll controls (clear votes, manual add)
    (function(){
      const ctrls = document.getElementById('admin-poll-controls');
      const clearBtn = document.getElementById('clear-all-votes');
      const clearFb = document.getElementById('clear-votes-feedback');
  const adminName = document.getElementById('admin-voter-name');
  const adminBooks = document.getElementById('admin-poll-books');
  const adminAdd = document.getElementById('admin-add-votes');
  const adminRefresh = document.getElementById('admin-refresh-books');
  const adminRemoveBtnInit = document.getElementById('admin-remove-votes');
  if(adminAdd) adminAdd.disabled = true;
  if(adminRemoveBtnInit) adminRemoveBtnInit.disabled = true;
      const adminFb = document.getElementById('admin-add-feedback');

      function showAdminPollControls(){ try{ if(ctrls) ctrls.classList.remove('d-none'); }catch(e){} }

      // Expose when leader becomes lead
      window.showAdminPollControls = showAdminPollControls;

      // Populate book list from localStorage.pollChoices ‚Äî only when the 3 choices are published
      function renderAdminBookList(){
        try{
          adminBooks.innerHTML = '';
          const pcs = JSON.parse(localStorage.getItem('pollChoices')||'[]');
          // Require at least 3 published choices before enabling manual vote tools
          if(!Array.isArray(pcs) || pcs.length < 3){
            adminBooks.innerHTML = '<div class="small text-muted">Poll choices are not ready yet ‚Äî waiting for 3 published choices. Refresh this list after the lead publishes the final choices.</div>';
            if(adminAdd) adminAdd.disabled = true;
            const adminRemoveBtn = document.getElementById('admin-remove-votes'); if(adminRemoveBtn) adminRemoveBtn.disabled = true;
            return;
          }
          // Render only the first three published choices (in order)
          pcs.slice(0,3).forEach((c, idx)=>{
            const id = 'admin-poll-book-'+idx;
            const wrapper = document.createElement('div'); wrapper.className = 'form-check';
            wrapper.style.minWidth='140px'; wrapper.style.marginRight='8px'; wrapper.style.marginBottom='6px';
            wrapper.innerHTML = `<input class="form-check-input" type="checkbox" value="${c.book}" id="${id}"><label class="form-check-label" for="${id}">${c.book}</label>`;
            adminBooks.appendChild(wrapper);
          });
          // Enable buttons now that choices are available
          if(adminAdd) adminAdd.disabled = false;
          const adminRemoveBtn2 = document.getElementById('admin-remove-votes'); if(adminRemoveBtn2) adminRemoveBtn2.disabled = false;
        }catch(e){ adminBooks.innerHTML = '<div class="small text-muted">Failed to load choices</div>'; }
      }

      // Clear all votes handler
      clearBtn && clearBtn.addEventListener('click', ()=>{
        try{
          localStorage.removeItem('votes');
          // Dispatch a storage-like event for same-window listeners
          try{ window.dispatchEvent(new StorageEvent('storage', { key:'votes', newValue: null })); }catch(e){}
          if(clearFb){ clearFb.style.display='inline'; clearTimeout(clearFb._t); clearFb._t = setTimeout(()=>clearFb.style.display='none',2500); }
        }catch(e){ console.warn(e); }
      });

      // Add votes for selected books for a given name
      adminAdd && adminAdd.addEventListener('click', ()=>{
        try{
          const name = (adminName && adminName.value || '').trim();
          if(!name) { alert('Enter a name to add votes for'); return; }
          const checked = Array.from(adminBooks.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
          if(!checked.length){ alert('Select at least one book to add votes for'); return; }
          const current = JSON.parse(localStorage.getItem('votes')||'{}');
          checked.forEach(book => {
            if(!current[book]) current[book] = [];
            if(!current[book].includes(name)) current[book].push(name);
          });
          localStorage.setItem('votes', JSON.stringify(current));
          // Notify other tabs
          try{ window.dispatchEvent(new StorageEvent('storage', { key:'votes', newValue: JSON.stringify(current) })); }catch(e){}
          if(adminFb){ adminFb.style.display='block'; clearTimeout(adminFb._t); adminFb._t = setTimeout(()=>adminFb.style.display='none',2500); }
        }catch(e){ console.warn(e); }
      });

      adminRefresh && adminRefresh.addEventListener('click', ()=>{ renderAdminBookList(); });

  // Also show and refresh when winners/pollChoices become available
  window.addEventListener('storage', (ev)=>{ if(ev.key==='pollChoices' || ev.key==='winners'){ try{ renderAdminBookList(); showAdminPollControls(); }catch(e){} } });
  window.addEventListener('winnersSaved',(ev)=>{ try{ renderAdminBookList(); showAdminPollControls(); }catch(e){} });
      // Remove votes handler
      const adminRemove = document.getElementById('admin-remove-votes');
      adminRemove && adminRemove.addEventListener('click', ()=>{
        try{
          const name = (adminName && adminName.value || '').trim();
          if(!name) { alert('Enter a name to remove votes for'); return; }
          const checked = Array.from(adminBooks.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
          if(!checked.length){ alert('Select at least one book to remove votes for'); return; }
          const current = JSON.parse(localStorage.getItem('votes')||'{}');
          let changed = false;
          checked.forEach(book => {
            if(current[book]){
              const before = current[book].length;
              current[book] = current[book].filter(n=>n!==name);
              if(current[book].length !== before) changed = true;
              if(current[book].length===0) delete current[book];
            }
          });
          if(changed){
            localStorage.setItem('votes', JSON.stringify(current));
            try{ window.dispatchEvent(new StorageEvent('storage', { key:'votes', newValue: JSON.stringify(current) })); }catch(e){}
            if(adminFb){ adminFb.style.display='block'; clearTimeout(adminFb._t); adminFb._t = setTimeout(()=>adminFb.style.display='none',2500); }
          } else { alert('No votes were removed (the name may not have had votes for the selected books).'); }
        }catch(e){ console.warn(e); }
      });
    })();

    // Finalize chosen book (mark final locally and offer CSV removal helper)
    (function(){
      const section = document.getElementById('finalize-section');
      const select = document.getElementById('final-book-select');
      const finalizeBtn = document.getElementById('finalize-btn');
      const undoBtn = document.getElementById('undo-finalize');
      const csvInput = document.getElementById('csvUrlInput');
      const downloadCsvBtn = document.getElementById('download-updated-csv');
      const fb = document.getElementById('finalize-feedback');
      const err = document.getElementById('finalize-error');

      function showFinalize(){ try{ section.classList.remove('d-none'); }catch(e){} }
      function populateSelect(){
        try{
          select.innerHTML = '<option value="">(select a book)</option>';
          const pcs = JSON.parse(localStorage.getItem('pollChoices')||'[]');
          if(Array.isArray(pcs)) pcs.slice(0,5).forEach(c=>{
            const opt = document.createElement('option'); opt.value = c.book; opt.textContent = c.book; select.appendChild(opt);
          });
        }catch(e){ }
      }

      // Expose helper to show the finalize area when lead
      window.showFinalizeSection = showFinalize;

      // Initialize when leader
      try{ if(sessionStorage.getItem('isLead')){ populateSelect(); showFinalize(); } }catch(e){}

      window.addEventListener('storage', (ev)=>{ if(ev.key==='pollChoices' || ev.key==='winners'){ try{ populateSelect(); showFinalize(); }catch(e){} } });
      window.addEventListener('winnersSaved',(ev)=>{ try{ populateSelect(); showFinalize(); }catch(e){} });

          // Finalize action: store finalized book in localStorage.finalized and remove from local pollChoices (local only)
      finalizeBtn && finalizeBtn.addEventListener('click', ()=>{
        try{
          const book = (select && select.value) || '';
          if(!book){ alert('Select a book to finalize'); return; }
          // Save previous state for undo
          const prev = { pollChoices: JSON.parse(localStorage.getItem('pollChoices')||'[]'), finalized: localStorage.getItem('finalized') };
          localStorage.setItem('_finalize_backup', JSON.stringify(prev));
          // Mark finalized
          const now = { book, when: (new Date()).toISOString() };
          localStorage.setItem('finalized', JSON.stringify(now));
          // Remove the finalized book from pollChoices locally
          const pcs = JSON.parse(localStorage.getItem('pollChoices')||'[]').filter(p=>p.book !== book);
          localStorage.setItem('pollChoices', JSON.stringify(pcs));
          // Dispatch storage-like events for same-window listeners
          try{ window.dispatchEvent(new StorageEvent('storage', { key:'finalized', newValue: JSON.stringify(now) })); }catch(e){}
          try{ window.dispatchEvent(new StorageEvent('storage', { key:'pollChoices', newValue: JSON.stringify(pcs) })); }catch(e){}
          if(fb){ fb.style.display='inline'; clearTimeout(fb._t); fb._t = setTimeout(()=>fb.style.display='none',2500); }
          // If an Apps Script endpoint is provided, POST the finalized book so Apps Script can remove the row server-side
          try{
            const endpoint = (document.getElementById('scriptEndpointInput')||{}).value||'';
            if(endpoint){
              (async ()=>{
                try{
                  const resp = await fetch(endpoint, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ action: 'removeRow', book: book }) });
                  const data = await resp.json();
                  if(!resp.ok) throw new Error(data && data.message ? data.message : 'Script error');
                  // show a small note that remote removal succeeded
                  if(fb){ fb.textContent = 'Finalized (remote removal requested)'; fb.style.display='inline'; clearTimeout(fb._t); fb._t = setTimeout(()=>{ fb.style.display='none'; fb.textContent='Finalized'; },3000); }
                }catch(e){ if(err){ err.style.display='inline'; err.textContent = 'Remote removal failed'; setTimeout(()=>err.style.display='none',3000); } }
              })();
            }
          }catch(e){}
          undoBtn.disabled = false;
          // enable download csv button only if csv url present
          if(csvInput && csvInput.value) downloadCsvBtn.disabled = false;
        }catch(e){ if(err){ err.style.display='inline'; err.textContent = 'Failed to finalize'; setTimeout(()=>err.style.display='none',2500); } }
      });

      // Undo finalize
      undoBtn && undoBtn.addEventListener('click', ()=>{
        try{
          const bak = JSON.parse(localStorage.getItem('_finalize_backup')||'null');
          if(!bak){ alert('No finalize backup found to undo'); return; }
          if(bak.pollChoices) localStorage.setItem('pollChoices', JSON.stringify(bak.pollChoices));
          if(bak.finalized) localStorage.setItem('finalized', bak.finalized); else localStorage.removeItem('finalized');
          localStorage.removeItem('_finalize_backup');
          try{ window.dispatchEvent(new StorageEvent('storage', { key:'pollChoices', newValue: JSON.stringify(bak.pollChoices||[]) })); }catch(e){}
          if(fb){ fb.style.display='inline'; fb.textContent='Undo successful'; clearTimeout(fb._t); fb._t = setTimeout(()=>fb.style.display='none',2500); }
          undoBtn.disabled = true;
        }catch(e){ if(err){ err.style.display='inline'; err.textContent='Undo failed'; setTimeout(()=>err.style.display='none',2500); } }
      });

      // Download updated CSV helper: fetch CSV, remove row matching finalized book (best-effort match by title portion)
      downloadCsvBtn && downloadCsvBtn.addEventListener('click', async ()=>{
        try{
          const url = (csvInput && csvInput.value||'').trim();
          if(!url){ alert('Enter the published CSV URL'); return; }
          const fin = JSON.parse(localStorage.getItem('finalized')||'null');
          if(!fin){ alert('No finalized book recorded'); return; }
          downloadCsvBtn.disabled = true; downloadCsvBtn.textContent='Preparing...';
          const resp = await fetch(url); if(!resp.ok) throw new Error('Failed to fetch CSV');
          const text = await resp.text();
          // Simple CSV parse by lines ‚Äî preserve header
          const lines = text.split(/\r?\n/);
          if(lines.length<=1) throw new Error('CSV appears empty');
          const header = lines[0];
          const rows = lines.slice(1).filter(Boolean);
          // Try to remove any row where the second column contains the finalized book title (case-insensitive)
          const normalizedTarget = fin.book.toLowerCase().replace(/\s*-\s*.*/,'').trim();
          const kept = rows.filter(r=>{
            const cols = r.split(',');
            const bookcol = (cols[1]||'').toLowerCase();
            // Normalize the left side of ' - '
            const left = bookcol.replace(/\s*-\s*.*/,'').trim();
            return left !== normalizedTarget;
          });
          const out = [header].concat(kept).join('\n');
          // Create a blob and download via temporary link
          const blob = new Blob([out], { type: 'text/csv;charset=utf-8;' });
          const urlObj = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = urlObj; a.download = 'updated.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(urlObj);
          downloadCsvBtn.textContent='Download updated CSV (remove finalized)';
          downloadCsvBtn.disabled = false;
        }catch(e){ console.warn(e); downloadCsvBtn.disabled=false; downloadCsvBtn.textContent='Download updated CSV (remove finalized)'; if(err){ err.style.display='inline'; err.textContent='CSV prep failed'; setTimeout(()=>err.style.display='none',2500);} }
      });

      // Enable download button when URL entered
      csvInput && csvInput.addEventListener('input', ()=>{ downloadCsvBtn.disabled = !(csvInput.value && localStorage.getItem('finalized')); });
    })();
  </script>
  <script>
(function(){
  let sheetOptions = [];
  let sheetLoaded = false;

  function getSheetUrl(){
    const el = document.getElementById('csvUrlInput');
    if(el && el.value && el.value.trim()) return el.value.trim();
  // Prefer explicit global, otherwise try a repository-relative CSV as a sensible default
  return window.sheetCsvUrl || '../sheet.csv' || '';
  }

  async function loadSheetOptions(){
    if(sheetLoaded) return sheetOptions;
    const url = getSheetUrl();
    if(!url) return sheetOptions;
    try{
      const res = await fetch(url);
      const csv = await res.text();
      sheetOptions = parseCsv(csv);
      sheetLoaded = true;
    }catch(e){
      console.warn('[admin] failed to load sheet CSV', e);
    }
    return sheetOptions;
  }

  function parseCsv(text){
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(lines.length === 0) return [];
    // Detect and skip a header row that contains column names like "Timestamp" or "Book Title"
    const firstCols = splitCsvLine(lines[0]).map(c=> (c||'').toLowerCase());
    let start = 0;
    if(firstCols.some(c => c.includes('timestamp') || c.includes('book') || c.includes('title') || c.includes('author'))){
      start = 1;
    }
    const rows = lines.slice(start).map(l => splitCsvLine(l));
    return rows.map(cols => {
      // Some sheets include a leading timestamp column. Detect date-like entries in cols[0].
      const first = (cols[0]||'').trim();
      const looksLikeTimestamp = /\d{1,4}[\/-]\d{1,2}[\/-]\d{1,4}|\d{1,2}:\d{2}|am|pm/i.test(first);
      const titleIndex = looksLikeTimestamp ? 1 : 0;
      const authorIndex = looksLikeTimestamp ? 2 : 1;
      const sugIndex = looksLikeTimestamp ? 3 : 2;
      const title = (cols[titleIndex]||'').trim();
      const author = (cols[authorIndex]||'').trim();
      const sug = (cols[sugIndex]||'').trim();
      const display = author ? `${title} - ${author}` : title;
      return { title, author, suggestedBy: sug, display, raw: cols };
    }).filter(o => o.title && !/\d{1,2}[\/:]\d{2}/.test(o.title));
  }

  function splitCsvLine(line){
    const res = [];
    let cur = '', inQ = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === '"' ) { inQ = !inQ; continue; }
      if(ch === ',' && !inQ){ res.push(cur); cur=''; continue; }
      cur += ch;
    }
    res.push(cur);
    return res;
  }

  function filterOptions(q){
    if(!q) return sheetOptions.slice(0,50);
    const qq = q.toLowerCase();
    return sheetOptions.filter(o => (o.display||'').toLowerCase().includes(qq) || (o.title||'').toLowerCase().includes(qq)).slice(0,50);
  }

  // Populate the per-panel datalist elements with all unique displays sorted alphabetically
  function populateDatalists(){
    try{
      const lists = Array.from(document.querySelectorAll('.edit-choice-datalist'));
      if(!lists.length) return;
      // Build unique list keyed by display
      const map = new Map();
      sheetOptions.forEach(o => { if(o && o.display) map.set(o.display, o); });
      // Sort alphabetically by book title (not by author portion)
      const all = Array.from(map.values()).sort((a,b)=> (a.title||'').localeCompare(b.title||'', undefined, { sensitivity: 'base' }));
      lists.forEach(dl => {
        // clear existing options
        dl.innerHTML = '';
        all.forEach(opt => {
          const el = document.createElement('option'); el.value = opt.display; dl.appendChild(el);
        });
      });
    }catch(e){ console.warn('populateDatalists failed', e); }
  }

  // Update the datalist for a given panel based on query and return the first match
  function showResults(panel, reelIndex, q){
    const input = panel.querySelector('.edit-choice-input');
    const results = panel.querySelector('.edit-choice-results');
    if(!input || !results) return null;
    const matches = filterOptions(q || '');
  // Sort matches alphabetically by book title (case-insensitive) so dropdown is ordered
  matches.sort((a,b)=> (a.title||'').localeCompare(b.title||'', undefined, { sensitivity: 'base' }));
    // populate styled results list
    results.innerHTML = '';
    if(matches.length === 0){
      results.classList.add('d-none'); results.setAttribute('aria-hidden','true');
      return null;
    }
    matches.forEach(opt => {
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'list-group-item list-group-item-action';
      item.textContent = opt.display;
      item.addEventListener('click', ()=>{ selectOptionForReel(reelIndex, opt, panel); });
      results.appendChild(item);
    });
    results.classList.remove('d-none'); results.setAttribute('aria-hidden','false');
    // If the input value exactly matches one of the displays, prefer that as selected
    const exact = matches.find(m => m.display === input.value);
    return exact || matches[0] || null;
  }

  function selectOptionForReel(reelIndex, opt, panel){
    try{
      // Render markup that matches the slot machine's stopped state: a .slot-scroll-list
      // containing a single .slot-scroll-item. Put the full "Title - Author" string
      // into the reel display and set the Suggested by line below.
      const slotScroll = document.querySelector(`#slot${reelIndex+1} .slot-scroll`);
      // Some rows may have been imported into a single cell ("Title - Author - Suggested By").
      // If the parsed opt.suggestedBy is empty but the display contains 2+ ' - ' segments,
      // treat the last segment as the suggester and render only Title - Author in the reel.
      let display = String(opt.display || '').trim();
      let suggested = (opt.suggestedBy || '').trim();
      if(!suggested){
        const parts = display.split(/\s-\s/);
        if(parts.length >= 3){
          suggested = parts.slice(2).join(' - ').trim();
          display = parts.slice(0,2).join(' - ').trim();
        }
      }
      if(slotScroll){
        slotScroll.innerHTML = `<div class="slot-scroll-list"><div class="slot-scroll-item" style="border-bottom:none">${escapeHtml(display)}</div></div>`;
      }
      const sugEl = document.getElementById(`suggested${reelIndex+1}-name`);
      if(sugEl) sugEl.textContent = suggested || '';

      // Persist winners using the same shape the slot machine uses: { title, suggestedBy }
      try{
        let winners = JSON.parse(localStorage.getItem('winners')||'null') || [];
  // Derive a plain title (without author) for the stored title field when possible
  const plainTitle = (opt.title && opt.title.trim()) ? opt.title.trim() : (String(display||'').split(/\s-\s/)[0]||String(display||'')).trim();
  winners[reelIndex] = { title: plainTitle, suggestedBy: suggested || '' };
        localStorage.setItem('winners', JSON.stringify(winners));
        try{ window.dispatchEvent(new CustomEvent('winnersSaved', { detail: winners })); }catch(e){}
      }catch(e){}

      // Also keep the older admin slotMachineState shape for backwards compatibility
      try{
        let sms = JSON.parse(localStorage.getItem('slotMachineState')||'null');
        if(Array.isArray(sms) && sms.length > reelIndex){
          // keep admin-era shape but store the visible Title - Author and suggester
          sms[reelIndex] = { book: display, name: suggested || '' };
          localStorage.setItem('slotMachineState', JSON.stringify(sms));
          try{ window.dispatchEvent(new StorageEvent('storage', { key:'slotMachineState', newValue: JSON.stringify(sms) })); }catch(e){}
        }
      }catch(e){}
    }catch(e){ console.warn('replace choice failed', e); }
    panel.classList.add('d-none');
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function initEditChoiceUI(){
    const editBtns = Array.from(document.querySelectorAll('.edit-choice'));
    editBtns.forEach(btn => {
      const idx = Number(btn.getAttribute('data-reel'));
      const panel = document.querySelector(`.edit-choice-panel[data-reel="${idx}"]`);
      const input = panel && panel.querySelector('.edit-choice-input');
      const datalist = panel && panel.querySelector('.edit-choice-datalist');
      btn.addEventListener('click', async ()=>{
        if(!sheetLoaded) await loadSheetOptions();
        panel.classList.toggle('d-none');
        if(!panel.classList.contains('d-none')){
          // populate selects when panel is opened (if options loaded)
          try{ populateDatalists(); }catch(e){}
          showResults(panel, idx, input.value || '');
          input.focus();
        }
      });
      if(input){
        input.addEventListener('input', (ev)=>{ showResults(panel, idx, ev.target.value); });
        input.addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter'){ ev.preventDefault(); const first = showResults(panel, idx, input.value); if(first) selectOptionForReel(idx, first, panel); } });
        // When the input loses focus or changes, if it matches an option exactly, apply it
        input.addEventListener('change', (ev)=>{
          const val = (ev.target && ev.target.value) || '';
          if(!val) return;
          // find matching option object by display
          const opt = sheetOptions.find(o=>o.display === val) || sheetOptions.find(o=>o.title === val) || { display: val, title: val, author: '' };
          if(opt) selectOptionForReel(idx, opt, panel);
        });
  // hide results when input loses focus after a short delay (to allow click)
  input.addEventListener('blur', ()=>{ setTimeout(()=>{ const r = panel.querySelector('.edit-choice-results'); if(r){ r.classList.add('d-none'); r.setAttribute('aria-hidden','true'); } }, 150); });
      }
      // datalist has no change events to select from; selection is handled via input's change/enter handlers above
    });
  }

  // Close any open panels when clicking outside
  document.addEventListener('click', (ev)=>{
    const target = ev.target;
    const isInside = target.closest && (target.closest('.edit-choice-panel') || target.closest('.edit-choice'));
    if(!isInside){
      document.querySelectorAll('.edit-choice-panel').forEach(p=>{ if(!p.classList.contains('d-none')) p.classList.add('d-none'); const r = p.querySelector('.edit-choice-results'); if(r){ r.classList.add('d-none'); r.setAttribute('aria-hidden','true'); } });
    }
  });

  window.showEditChoiceForReel = function(reelIndex){
    try{ const btn = document.querySelector(`.edit-choice[data-reel="${reelIndex}"]`); if(btn) btn.classList.remove('d-none'); }catch(e){}
  };

  document.addEventListener('DOMContentLoaded', ()=>{
    initEditChoiceUI();
    try{
      // On load, reveal edit buttons only when the reel appears to be stopped
      // (the stop button is hidden with .d-none and/or disabled by the slot script when stopped).
      for(let i=1;i<=3;i++){
        const stopBtn = document.getElementById('slotStopBtn'+i);
        const editBtn = document.querySelector(`.edit-choice[data-reel="${i-1}"]`);
  if(stopBtn && stopBtn.classList.contains('d-none') && editBtn){
          editBtn.classList.remove('d-none');
        }
      }
    }catch(e){}

    // Reveal the Edit button for a reel when that reel has been stopped.
    try{
      // Wire stop button clicks: when a reel's Stop button is clicked, show its Edit button
      for(let i=1;i<=3;i++){
        (function(idx){
          const stopBtn = document.getElementById('slotStopBtn'+idx);
          const editBtn = document.querySelector(`.edit-choice[data-reel="${idx-1}"]`);
          if(stopBtn && editBtn){
            stopBtn.addEventListener('click', ()=>{ editBtn.classList.remove('d-none'); });
          }
        })(i);
      }

      // Also reveal when storage updates indicate a reel has a selection (other tabs or scripts)
      window.addEventListener('storage', (ev)=>{
        if(!ev) return;
        try{
          if((ev.key === 'slotMachineState' || ev.key === 'winners') && ev.newValue){
            const arr = JSON.parse(ev.newValue || 'null') || [];
            arr.forEach((s, idx)=>{
              if(s && (s.book || s.title)){
                const stopBtn = document.getElementById('slotStopBtn'+(idx+1));
                const edit = document.querySelector(`.edit-choice[data-reel="${idx}"]`);
                if(edit && stopBtn && stopBtn.classList.contains('d-none')){
                  edit.classList.remove('d-none');
                }
              }
            });
          }
        }catch(e){}
      });

      // In-window custom event used elsewhere in the app ‚Äî reveal matching edit buttons when winnersSaved fires
      window.addEventListener('winnersSaved', (ev)=>{
        try{
          const w = (ev && ev.detail) || JSON.parse(localStorage.getItem('winners')||'null') || [];
          w.forEach((s, idx)=>{
            if(s && (s.book || s.title)){
              const stopBtn = document.getElementById('slotStopBtn'+(idx+1));
              const edit = document.querySelector(`.edit-choice[data-reel="${idx}"]`);
              if(edit && stopBtn && stopBtn.classList.contains('d-none')){
                edit.classList.remove('d-none');
              }
            }
          });
        }catch(e){}
      });
    }catch(e){}
    // Attempt to load the published sheet CSV on page load and populate the "choose from all" selects.
    try{
      loadSheetOptions().then(()=>{
        try{ populateDatalists(); }catch(e){}
      }).catch(()=>{/* ignore */});
    }catch(e){}
  });
})();
  </script>
</body>
</html>