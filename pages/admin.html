<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Book Slot Machine</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/styles.css" rel="stylesheet">
  <!-- Favicons -->
  <link rel="icon" href="../favicon/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png" />
  <link rel="manifest" href="../favicon/site.webmanifest" />
  <meta name="theme-color" content="#ffffff">
  <style>
    /* Site-wide nav styles copied from index.html for consistent header */
    .site-nav { text-align:center; margin: 1rem 0; }
    .site-nav a {
      display: inline-block;
      margin: 0.6rem 1rem;
      padding: 0.6rem 1.2rem;
      background: #f6f6f6;
      color: #333;
      border-radius: 10px;
      text-decoration: none;
      border: 1px solid #ddd;
      font-size: 1rem;
      transition: background 0.2s, color 0.2s;
    }
    .site-nav a:hover { background: #aee; color: #105; }
    .site-nav a.active { background:#ffc107; color:#111; border-color:#e0a800; }
  /* Lightweight custom modal for spin confirmation */
  /* Scroll-lock body while modal is open */
  body.modal-open { overflow: hidden; height: 100vh; touch-action: none; }
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.46); display: flex; align-items: center; justify-content: center; z-index: 1050; padding: 12px; }
  .modal-card { background: #fff; border-radius: 10px; max-width: 520px; width: 100%; padding: 14px 16px; box-shadow: 0 12px 36px rgba(0,0,0,0.28); border: 1px solid rgba(0,0,0,0.06); transform: translateY(8px); opacity: 0; transition: transform .18s ease, opacity .18s ease; }
  .modal-overlay.show .modal-card { transform: translateY(0); opacity: 1; }
  .modal-card h3 { margin: 0 0 6px 0; font-size: 1rem; font-weight:600; }
  .modal-card p { margin: 0; color: #222; font-size: 0.96rem; line-height:1.35; }
  .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
  /* larger touch targets */
  .modal-actions .btn { min-width: 96px; padding: 10px 14px; font-size: 1rem; border-radius: 8px; }
  .modal-actions .btn.btn-primary { background:#0b5ed7; border-color:#0a58ca; color:#fff; }
  .modal-actions .btn.btn-outline-secondary { color:#333; border-color:rgba(0,0,0,0.12); }
  @media (max-width:420px){ .modal-actions { flex-direction: column-reverse; } .modal-actions .btn{ width:100%; } }
  .modal-overlay.d-none { display: none; }
  /* Custom styled dropdown for Edit Choice panels to match site look */
  .edit-choice-panel { position: relative; }
  .edit-choice-datalist { display: none !important; } /* hide native datalist UI in favor of styled list */
  .edit-choice-results {
    position: absolute;
    left: 0;
    right: 0;
    z-index: 2050;
    margin-top: 6px;
    max-height: 220px;
    overflow: auto;
    border: 1px solid rgba(0,0,0,0.08);
    background: #fff;
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    border-radius: 8px;
  }
  .edit-choice-results .list-group-item{ cursor: pointer; padding: 8px 10px; font-size: 0.95rem; }
  .edit-choice-results .list-group-item:hover{ background:#f1f7fb; }
  </style>
  <style>
    /* Admin toast */
    .admin-toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: rgba(33,33,33,0.95);
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      font-size: 0.95rem;
      z-index: 9999;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 220ms ease, transform 220ms ease;
      pointer-events: none;
    }
    .admin-toast.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
  </style>
</head>
<body>
  <header style="text-align:center; margin:1rem 0;">
  <a href="../index.html" class="btn btn-secondary">üè† Main Page</a>
  </header>
  <!-- Very prominent start-new-session action for admin -->
  <div style="max-width:900px;margin:0.6rem auto 0;">
    <button id="topStartNewSessionBtn" class="btn btn-lg btn-primary w-100" style="font-size:1.45rem;padding:18px;">Start new book voting session</button>
  </div>
  <div class="container">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h1 class="h4">Admin: Book Slot Machine</h1>
        <p class="small text-muted">This page is for the club lead to control the SPIN / RESET actions for choosing next month's book. Only one person should be in control at a time.</p>
  <div id="admin-msg" class="mt-2"><small id="qr-status" class="text-muted"></small></div>
        <div class="mt-3">
          <a href="voting.html" class="btn btn-secondary me-2">Member View</a>
          <a href="voting_poll.html" class="btn btn-info">Open Voting Poll</a>
        </div>
        <!-- Member View share panel (lead can share this with members) -->
        <div id="member-share" class="mt-3 d-none">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6">Share: Member View</h2>
              <p class="small text-muted">Share this link or QR code with group members so they can open the Member View.</p>
              <div class="d-flex gap-3 align-items-center">
                <div class="qr-wrap-member" style="width:120px;flex:0 0 120px;">
                  <img id="member-qr" src="" alt="Member View QR" style="width:120px;height:120px;border:1px solid #e6e6e6;border-radius:8px;background:#fff;padding:6px;" />
                </div>
                <div class="flex-grow-1">
                  <p class="mb-2"><strong>Member view URL</strong></p>
                  <div class="d-flex gap-2 align-items-center">
                    <input id="memberLink" type="text" class="form-control" value="https://paulbenson88.github.io/Book-Club/pages/voting.html" />
                    <button id="copyMemberLink" class="btn btn-outline-primary">Copy link</button>
                    <a id="openMember" href="voting.html" class="btn btn-secondary">Open Member View</a>
                  </div>
                  <div id="copyMemberFeedback" class="small text-success mt-2" style="display:none;">Link copied to clipboard</div>
                  <div id="member-hint" class="small text-muted mt-2" style="display:none;">Use an https:// URL for QR scanners to open the page directly.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <div id="slot-area">
  <div class="alert alert-info small">Admin controls: anyone on this page may operate the slot machine.</div>
      <div id="slot-host" class="mt-3">
          <div id="slot-container" class="d-none">
            <div class="slot-machine-frame">
          <div class="slot-machine-title">BOOK SLOT MACHINE</div>
          <div class="d-flex justify-content-center my-3"><button id="slotSpinBtn" class="btn spin-center-btn">SPIN</button></div>
          <div class="slot-reels">
            <div class="slot-reel" id="slot1">
              <div class="slot-scroll" id="slotScroll1"><div class="slot-scroll-list"></div></div>
              <button id="slotStopBtn1" class="btn stop-btn mt-2" disabled>Stop</button>
              <button class="btn reel-respin mt-2 d-none" data-reel="0" disabled>‚ü≤ Respin</button>
              <button class="btn btn-outline-secondary edit-choice mt-2 d-none" data-reel="0">Edit Choice</button>
              <div class="edit-choice-panel mt-2 d-none" data-reel="0">
                <input type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="form-control edit-choice-input" placeholder="Search or choose a book..." aria-label="Search or choose a book" />
                <datalist id="edit-choice-list-0" class="edit-choice-datalist"></datalist>
                <div class="edit-choice-results list-group d-none" aria-hidden="true"></div>
                <div class="small text-muted mt-1">Select a book to replace this reel.</div>
              </div>
               <div class="suggested-by text-muted small mt-1 text-center">Suggested by: <span id="suggested1-name"></span></div>
            </div>
            <div class="slot-reel" id="slot2">
              <div class="slot-scroll" id="slotScroll2"><div class="slot-scroll-list"></div></div>
              <button id="slotStopBtn2" class="btn stop-btn mt-2" disabled>Stop</button>
              <button class="btn reel-respin mt-2 d-none" data-reel="1" disabled>‚ü≤ Respin</button>
              <button class="btn btn-outline-secondary edit-choice mt-2 d-none" data-reel="1">Edit Choice</button>
              <div class="edit-choice-panel mt-2 d-none" data-reel="1">
                <input type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="form-control edit-choice-input" placeholder="Search or choose a book..." aria-label="Search or choose a book" />
                <datalist id="edit-choice-list-1" class="edit-choice-datalist"></datalist>
                <div class="edit-choice-results list-group d-none" aria-hidden="true"></div>
                <div class="small text-muted mt-1">Select a book to replace this reel.</div>
              </div>
              <div class="suggested-by text-muted small mt-1 text-center">Suggested by: <span id="suggested2-name"></span></div>
            </div>
            <div class="slot-reel" id="slot3">
              <div class="slot-scroll" id="slotScroll3"><div class="slot-scroll-list"></div></div>
              <button id="slotStopBtn3" class="btn stop-btn mt-2" disabled>Stop</button>
              <button class="btn reel-respin mt-2 d-none" data-reel="2" disabled>‚ü≤ Respin</button>
              <button class="btn btn-outline-secondary edit-choice mt-2 d-none" data-reel="2">Edit Choice</button>
              <div class="edit-choice-panel mt-2 d-none" data-reel="2">
                <input type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="form-control edit-choice-input" placeholder="Search or choose a book..." aria-label="Search or choose a book" />
                <datalist id="edit-choice-list-2" class="edit-choice-datalist"></datalist>
                <div class="edit-choice-results list-group d-none" aria-hidden="true"></div>
                <div class="small text-muted mt-1">Select a book to replace this reel.</div>
              </div>
              <div class="suggested-by text-muted small mt-1 text-center">Suggested by: <span id="suggested3-name"></span></div>
            </div>
          </div>
          <div id="slotResult" class="slot-result"></div>
          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <button id="forcePublishBtn" class="btn btn-success">Submit choices / Create Vote</button>
            <button id="forceClearBtn" class="btn btn-outline-secondary">Clear Poll</button>
            <button id="announceWinnerBtn" class="btn btn-warning">All votes in ‚Äî Announce Winner</button>
          </div>
          <div id="slotLoading" class="text-muted text-center mt-2 small">Loading book list...</div>
          
        </div>
            <!-- Voting poll share panel (hidden until pollChoices present) -->
            <div id="poll-share" class="mt-4 d-none">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h2 class="h5">Go to Voting Poll</h2>
                  <p class="small text-muted">Once all three books have been chosen, click the button below to open the voting poll. Share the QR code or copy the poll link to invite members to vote.</p>
                  <div class="d-flex gap-3 align-items-center">
                    <div class="qr-wrap" style="width:120px;flex:0 0 120px;">
                      <img id="poll-qr" src="" alt="Voting Poll QR" style="width:120px;height:120px;border:1px solid #e6e6e6;border-radius:8px;background:#fff;padding:6px;" />
                    </div>
                    <div class="flex-grow-1">
                      <p class="mb-2"><strong>Voting poll URL</strong></p>
                      <div class="d-flex gap-2 align-items-center">
                        <input id="pollLink" type="text" class="form-control" value="https://paulbenson88.github.io/Book-Club/pages/voting_poll.html" />
                        <button id="copyPollLink" class="btn btn-outline-primary">Copy link</button>
                        <a id="openPoll" href="voting_poll.html" class="btn btn-primary">Open Poll</a>
                      </div>
                      <div id="copyFeedback" class="small text-success mt-2" style="display:none;">Link copied to clipboard</div>
                      <div id="poll-hint" class="small text-muted mt-2" style="display:none;">Scanners often cannot open file:// or plain filenames‚Äîpaste a public https:// URL above for a working QR.</div>
                      <p class="small text-muted mt-2 mb-0">Share this QR code or the link via text or social channels.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
                <!-- Legacy manual poll controls removed (replaced by searchable dropdown edit UI) -->
      </div>
    </div>
  </div>

  <script src="../js/qrcode.min.js"></script>
  <!-- Firebase SDK (placeholder) -->
  <!--
    To enable Firestore publishing:
    1) Create a Firebase project at https://console.firebase.google.com/
    2) Add a Web app and copy the config below into the firebaseConfig object.
    3) Enable Firestore in the console and add rules that allow writes from an authenticated admin only.
    4) Replace the placeholder values below.
  -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <!-- Slot confirmation modal (shown before Spin or Reset) -->
  <div id="slotConfirmModal" class="modal-overlay d-none" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="slotConfirmTitle">
      <h3 id="slotConfirmTitle">Confirm slot operation</h3>
      <p id="slotConfirmMessage">Only proceed if you're the designated spinner ‚Äî this will overwrite someone else's results.</p>
      <div class="modal-actions">
        <button id="slotConfirmCancel" class="btn btn-outline-secondary">Cancel</button>
        <button id="slotConfirmOk" class="btn btn-primary">Proceed</button>
      </div>
    </div>
  </div>
  <!-- Start Poll preview modal (moved out of script) -->
  <div id="startPollModal" class="modal-overlay d-none" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="startPollTitle">
      <h3 id="startPollTitle">Preview poll choices</h3>
      <div id="startPollList" style="margin-top:8px;"></div>
      <div class="modal-actions">
        <button id="startPollCancel" class="btn btn-outline-secondary">Cancel</button>
        <button id="startPollConfirm" class="btn btn-success">Publish Poll</button>
      </div>
    </div>
  </div>
  <!-- Admin toast container -->
  <div id="adminToast" class="admin-toast" aria-live="polite" role="status" style="display:none;"></div>
  <script>
    (function(){
      const msg = document.getElementById('admin-msg');
      const host = document.getElementById('slot-host');

  // Reveal slot UI for any visitor and load voting script
  try{ const cont = document.getElementById('slot-container'); if(cont) cont.classList.remove('d-none'); }catch(e){}
  try{ loadVotingScript(); }catch(e){}

        function loadVotingScript(){
        if(document.querySelector('script[data-voting-loaded]')) return;
        const s = document.createElement('script'); s.src = '../js/voting.js'; s.setAttribute('data-voting-loaded','1'); document.body.appendChild(s);
      }

  // Manual poll UI removed ‚Äî manual save/clear handlers cleaned up.
    })();
  // QR + copy-link handling for voting poll (use local QR lib, show panel only when pollChoices present)
    (function(){
  const pollUrl = 'https://paulbenson88.github.io/Book-Club/pages/voting_poll.html';
      // expose canonical poll url for other scripts
      try{ window.adminPollUrl = pollUrl; }catch(e){}
      const linkInput = document.getElementById('pollLink');
      const copyBtn = document.getElementById('copyPollLink');
      const openBtn = document.getElementById('openPoll');
      const feedback = document.getElementById('copyFeedback');
      const pollShare = document.getElementById('poll-share');

      function showSharePanel(){
        // ensure poll-share is visible
        try{ if(pollShare){ pollShare.classList.remove('d-none'); pollShare.style.display='block'; } }catch(e){}
  renderQR();
  // schedule a follow-up render in case QR lib wasn't ready yet
  setTimeout(()=>{ try{ renderQR(); }catch(e){ } },300);
      }

      function renderQR(url){
        try{
          const u = url || (linkInput && linkInput.value) || pollUrl;
          console.log('[admin] renderQR called, url=', u);
          // Render as a simple <img> pointing to the qrserver API (matches old voting.html)
          const wrap = document.querySelector('.qr-wrap');
          const statusEl = document.getElementById('qr-status');
          let img = document.getElementById('poll-qr');
          if(!img){ if(wrap){ img = document.createElement('img'); img.className = 'qr'; img.id='poll-qr'; img.alt='QR code for voting poll'; img.style.width='120px'; img.style.height='120px'; img.style.border='1px solid #e6e6e6'; img.style.borderRadius='8px'; img.style.background='#fff'; img.style.padding='6px'; wrap.innerHTML=''; wrap.appendChild(img); } }
          if(img){
            // encode the absolute URL so phones open the page instead of searching for a filename
            const qrData = encodeURIComponent(u);
            img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=' + qrData;
          }
          if(linkInput) linkInput.value = u;
          if(openBtn) openBtn.href = u;
          console.log('[admin] renderQR finished');
          const hint = document.getElementById('poll-hint');
          if(hint) hint.style.display = (/^https?:\/\//i.test(u) ? 'none' : 'block');
        }catch(e){ console.warn('QR render failed',e); }
      }

      // expose helpers so other handlers can trigger showing/re-rendering
  window.showAdminPollShare = showSharePanel;
  window.renderAdminPollQR = renderQR;

      if(copyBtn){ copyBtn.addEventListener('click', async ()=>{
        try{
          const toCopy = (linkInput && linkInput.value) || pollUrl;
          await navigator.clipboard.writeText(toCopy);
          if(feedback){ feedback.style.display='block'; setTimeout(()=>feedback.style.display='none',2000); }
        }catch(err){ try{ linkInput.select(); }catch(e){} }
      }); }

  // Re-render when admin edits the poll link input
  if(linkInput){ linkInput.addEventListener('change', ()=>{ try{ renderQR(linkInput.value); }catch(e){} }); }

      // Show share panel only if there are published pollChoices
      try{
        const pcs = JSON.parse(localStorage.getItem('pollChoices') || 'null');
  if(Array.isArray(pcs) && pcs.length>=3){ try{ if(window.showAdminPollShare) window.showAdminPollShare(); else { const _ps = document.getElementById('poll-share'); if(_ps){ _ps.classList.remove('d-none'); _ps.style.display='block'; try{ if(window.renderAdminPollQR) window.renderAdminPollQR(); }catch(e){} } } }catch(e){} }
      }catch(e){ /* ignore */ }

  // Start Poll flow removed ‚Äî publishing handled elsewhere or not used in this build.

      // Listen for storage events so panel appears when pollChoices are saved in another tab
      window.addEventListener('storage', (ev)=>{
        if(ev.key==='pollChoices' && ev.newValue){
          try{ const w = JSON.parse(ev.newValue); if(Array.isArray(w) && w.length>=3) try{ if(window.showAdminPollShare) window.showAdminPollShare(); else { const _ps = document.getElementById('poll-share'); if(_ps){ _ps.classList.remove('d-none'); _ps.style.display='block'; try{ if(window.renderAdminPollQR) window.renderAdminPollQR(); }catch(e){} } } }catch(e){} }catch(e){}
        }
      });
  // Also listen for same-window custom events from the slot script
  window.addEventListener('pollPublished',(ev)=>{ try{ const w = ev.detail; if(Array.isArray(w) && w.length>=3) try{ if(window.showAdminPollShare) window.showAdminPollShare(); else { const _ps = document.getElementById('poll-share'); if(_ps){ _ps.classList.remove('d-none'); _ps.style.display='block'; try{ if(window.renderAdminPollQR) window.renderAdminPollQR(); }catch(e){} } } }catch(e){} }catch(e){} });
  window.addEventListener('pollCleared', ()=>{ try{ if(pollShare) pollShare.classList.add('d-none'); }catch(e){} });
      // ensure QR image has a src on load so the img doesn't show alt text
      try{ renderQR(); }catch(e){}
    })();

    // Member view share handling (top panel)
    (function(){
  const memberUrl = 'https://paulbenson88.github.io/Book-Club/pages/voting.html';
      const memberInput = document.getElementById('memberLink');
      const copyMemberBtn = document.getElementById('copyMemberLink');
      const openMemberBtn = document.getElementById('openMember');
      const memberShare = document.getElementById('member-share');
      const memberFeedback = document.getElementById('copyMemberFeedback');

      function showMemberPanel(){ try{ if(memberShare){ memberShare.classList.remove('d-none'); memberShare.style.display='block'; } }catch(e){}
      }
      // Admin force publish button (ensures poll is only published when admin confirms)
      try{
        const forceBtn = document.getElementById('forcePublishBtn');
        const forceClear = document.getElementById('forceClearBtn');
        const announceBtn = document.getElementById('announceWinnerBtn');
  if(forceBtn){ forceBtn.addEventListener('click', ()=>{ try{ if(window.adminPublishPoll) window.adminPublishPoll(); console.log('[admin] forcePublish clicked'); try{ if(window.showAdminPollShare) window.showAdminPollShare(); else { const _ps = document.getElementById('poll-share'); if(_ps){ _ps.classList.remove('d-none'); _ps.style.display='block'; try{ if(window.renderAdminPollQR) window.renderAdminPollQR(); }catch(e){} } } }catch(e){} }catch(e){ console.warn(e); } }); }
  if(forceClear){ forceClear.addEventListener('click', ()=>{ try{ if(window.adminClearPoll) window.adminClearPoll(); console.log('[admin] forceClear clicked'); const _pollShare = document.getElementById('poll-share'); if(_pollShare) _pollShare.classList.add('d-none'); }catch(e){ console.warn(e); } }); }
        if(announceBtn){ announceBtn.addEventListener('click', ()=>{
          try{
            // If there is a finalized selection UI, prefer that; otherwise pick top choice from pollChoices
            let winner = null;
            try{ const pcs = JSON.parse(localStorage.getItem('pollChoices')||'[]'); if(Array.isArray(pcs) && pcs.length>0) winner = pcs[0] && (pcs[0].book||pcs[0]); }catch(e){}
            if(!winner){ winner = prompt('Enter the winning book title to announce:'); }
            if(winner){ if(window.adminAnnounceWinner) window.adminAnnounceWinner(winner); console.log('[admin] announced winner', winner); const _pollShare = document.getElementById('poll-share'); if(_pollShare) _pollShare.classList.add('d-none'); showAdminToast('Winner announced to viewers: '+winner); }
          }catch(e){ console.warn(e); }
        }); }
      }catch(e){}

      function renderMemberQR(url){
        try{
          const u = url || (memberInput && memberInput.value) || memberUrl;
          const wrap = document.querySelector('.qr-wrap-member');
          let img = document.getElementById('member-qr');
          if(img){
            const qrData = encodeURIComponent(u);
            img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=' + qrData;
          }
          if(memberInput) memberInput.value = u;
          if(openMemberBtn) openMemberBtn.href = u;
          const hint = document.getElementById('member-hint'); if(hint) hint.style.display = (/^https?:\/\//i.test(u) ? 'none' : 'block');
        }catch(e){ console.warn('renderMemberQR failed', e); }
      }

      window.showAdminMemberShare = showMemberPanel;

      if(copyMemberBtn){ copyMemberBtn.addEventListener('click', async ()=>{
        try{ const toCopy = (memberInput && memberInput.value) || memberUrl; await navigator.clipboard.writeText(toCopy); if(memberFeedback){ memberFeedback.style.display='block'; setTimeout(()=>memberFeedback.style.display='none',2000); } }catch(err){ try{ memberInput.select(); }catch(e){} }
      }); }

      if(memberInput){ memberInput.addEventListener('change', ()=>{ try{ renderMemberQR(memberInput.value); }catch(e){} }); }

  // Show member panel if leader or always render small QR on load
  try{ if(sessionStorage.getItem('isLead')) showMemberPanel(); }catch(e){}
      try{ renderMemberQR(); }catch(e){}
    })();

    // End lead session button handler
    (function(){
  // ensure admin controls are visible and populated immediately
  try{ renderAdminBookList(); showAdminPollControls(); }catch(e){}
    })();

    // Wire up the prominent top Start New Session button
    (function(){
      try{
        const topBtn = document.getElementById('topStartNewSessionBtn');
  if(topBtn){ topBtn.addEventListener('click', ()=>{ try{ if(window.adminStartNewSession) window.adminStartNewSession(); console.log('[admin] top startNewSession clicked'); const _pollShare = document.getElementById('poll-share'); if(_pollShare) _pollShare.classList.add('d-none'); showAdminToast('Started a new voting session (cleared winner and poll choices).'); }catch(e){ console.warn(e); } }); }
      }catch(e){}
    })();

    // Admin toast helper
    function showAdminToast(text, ms=2500){
      try{
        const t = document.getElementById('adminToast'); if(!t) return;
        t.textContent = text; t.style.display = 'block'; t.classList.add('show');
        clearTimeout(t._hideTimer);
        t._hideTimer = setTimeout(()=>{ try{ t.classList.remove('show'); setTimeout(()=>{ t.style.display='none'; },240); }catch(e){} }, ms);
      }catch(e){ console.warn('showAdminToast failed', e); }
    }

  // Legacy manual admin poll controls removed (functionality replaced by searchable dropdowns/edit UI in slot machine)

    // Finalize chosen book (mark final locally and offer CSV removal helper)
    (function(){
      const section = document.getElementById('finalize-section');
      const select = document.getElementById('final-book-select');
      const finalizeBtn = document.getElementById('finalize-btn');
      const undoBtn = document.getElementById('undo-finalize');
      const csvInput = document.getElementById('csvUrlInput');
      const downloadCsvBtn = document.getElementById('download-updated-csv');
      const fb = document.getElementById('finalize-feedback');
      const err = document.getElementById('finalize-error');

      function showFinalize(){ try{ section.classList.remove('d-none'); }catch(e){} }
      function populateSelect(){
        try{
          select.innerHTML = '<option value="">(select a book)</option>';
          const pcs = JSON.parse(localStorage.getItem('pollChoices')||'[]');
          if(Array.isArray(pcs)) pcs.slice(0,5).forEach(c=>{
            const opt = document.createElement('option'); opt.value = c.book; opt.textContent = c.book; select.appendChild(opt);
          });
        }catch(e){ }
      }

      // Expose helper to show the finalize area when lead
      window.showFinalizeSection = showFinalize;

      // Initialize when leader
      try{ if(sessionStorage.getItem('isLead')){ populateSelect(); showFinalize(); } }catch(e){}

  window.addEventListener('storage', (ev)=>{ if(ev.key==='pollChoices'){ try{ populateSelect(); showFinalize(); }catch(e){} } });
  window.addEventListener('pollPublished',(ev)=>{ try{ populateSelect(); showFinalize(); }catch(e){} });

          // Finalize action: store finalized book in localStorage.finalized and remove from local pollChoices (local only)
      finalizeBtn && finalizeBtn.addEventListener('click', ()=>{
        try{
          const book = (select && select.value) || '';
          if(!book){ alert('Select a book to finalize'); return; }
          // Save previous state for undo
          const prev = { pollChoices: JSON.parse(localStorage.getItem('pollChoices')||'[]'), finalized: localStorage.getItem('finalized') };
          localStorage.setItem('_finalize_backup', JSON.stringify(prev));
          // Mark finalized
          const now = { book, when: (new Date()).toISOString() };
          localStorage.setItem('finalized', JSON.stringify(now));
          // Remove the finalized book from pollChoices locally
          const pcs = JSON.parse(localStorage.getItem('pollChoices')||'[]').filter(p=>p.book !== book);
          localStorage.setItem('pollChoices', JSON.stringify(pcs));
          // Dispatch storage-like events for same-window listeners
          try{ window.dispatchEvent(new StorageEvent('storage', { key:'finalized', newValue: JSON.stringify(now) })); }catch(e){}
          try{ window.dispatchEvent(new StorageEvent('storage', { key:'pollChoices', newValue: JSON.stringify(pcs) })); }catch(e){}
          if(fb){ fb.style.display='inline'; clearTimeout(fb._t); fb._t = setTimeout(()=>fb.style.display='none',2500); }
          // If an Apps Script endpoint is provided, POST the finalized book so Apps Script can remove the row server-side
          try{
            const endpoint = (document.getElementById('scriptEndpointInput')||{}).value||'';
            if(endpoint){
              (async ()=>{
                try{
                  const resp = await fetch(endpoint, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ action: 'removeRow', book: book }) });
                  const data = await resp.json();
                  if(!resp.ok) throw new Error(data && data.message ? data.message : 'Script error');
                  // show a small note that remote removal succeeded
                  if(fb){ fb.textContent = 'Finalized (remote removal requested)'; fb.style.display='inline'; clearTimeout(fb._t); fb._t = setTimeout(()=>{ fb.style.display='none'; fb.textContent='Finalized'; },3000); }
                }catch(e){ if(err){ err.style.display='inline'; err.textContent = 'Remote removal failed'; setTimeout(()=>err.style.display='none',3000); } }
              })();
            }
          }catch(e){}
          undoBtn.disabled = false;
          // enable download csv button only if csv url present
          if(csvInput && csvInput.value) downloadCsvBtn.disabled = false;
        }catch(e){ if(err){ err.style.display='inline'; err.textContent = 'Failed to finalize'; setTimeout(()=>err.style.display='none',2500); } }
      });

      // Undo finalize
      undoBtn && undoBtn.addEventListener('click', ()=>{
        try{
          const bak = JSON.parse(localStorage.getItem('_finalize_backup')||'null');
          if(!bak){ alert('No finalize backup found to undo'); return; }
          if(bak.pollChoices) localStorage.setItem('pollChoices', JSON.stringify(bak.pollChoices));
          if(bak.finalized) localStorage.setItem('finalized', bak.finalized); else localStorage.removeItem('finalized');
          localStorage.removeItem('_finalize_backup');
          try{ window.dispatchEvent(new StorageEvent('storage', { key:'pollChoices', newValue: JSON.stringify(bak.pollChoices||[]) })); }catch(e){}
          if(fb){ fb.style.display='inline'; fb.textContent='Undo successful'; clearTimeout(fb._t); fb._t = setTimeout(()=>fb.style.display='none',2500); }
          undoBtn.disabled = true;
        }catch(e){ if(err){ err.style.display='inline'; err.textContent='Undo failed'; setTimeout(()=>err.style.display='none',2500); } }
      });

      // Download updated CSV helper: fetch CSV, remove row matching finalized book (best-effort match by title portion)
      downloadCsvBtn && downloadCsvBtn.addEventListener('click', async ()=>{
        try{
          const url = (csvInput && csvInput.value||'').trim();
          if(!url){ alert('Enter the published CSV URL'); return; }
          const fin = JSON.parse(localStorage.getItem('finalized')||'null');
          if(!fin){ alert('No finalized book recorded'); return; }
          downloadCsvBtn.disabled = true; downloadCsvBtn.textContent='Preparing...';
          const resp = await fetch(url); if(!resp.ok) throw new Error('Failed to fetch CSV');
          const text = await resp.text();
          // Simple CSV parse by lines ‚Äî preserve header
          const lines = text.split(/\r?\n/);
          if(lines.length<=1) throw new Error('CSV appears empty');
          const header = lines[0];
          const rows = lines.slice(1).filter(Boolean);
          // Try to remove any row where the second column contains the finalized book title (case-insensitive)
          const normalizedTarget = fin.book.toLowerCase().replace(/\s*-\s*.*/,'').trim();
          const kept = rows.filter(r=>{
            const cols = r.split(',');
            const bookcol = (cols[1]||'').toLowerCase();
            // Normalize the left side of ' - '
            const left = bookcol.replace(/\s*-\s*.*/,'').trim();
            return left !== normalizedTarget;
          });
          const out = [header].concat(kept).join('\n');
          // Create a blob and download via temporary link
          const blob = new Blob([out], { type: 'text/csv;charset=utf-8;' });
          const urlObj = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = urlObj; a.download = 'updated.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(urlObj);
          downloadCsvBtn.textContent='Download updated CSV (remove finalized)';
          downloadCsvBtn.disabled = false;
        }catch(e){ console.warn(e); downloadCsvBtn.disabled=false; downloadCsvBtn.textContent='Download updated CSV (remove finalized)'; if(err){ err.style.display='inline'; err.textContent='CSV prep failed'; setTimeout(()=>err.style.display='none',2500);} }
      });

      // Enable download button when URL entered
      csvInput && csvInput.addEventListener('input', ()=>{ downloadCsvBtn.disabled = !(csvInput.value && localStorage.getItem('finalized')); });
    })();
  </script>
  <script>
(function(){
  let sheetOptions = [];
  let sheetLoaded = false;

  function getSheetUrl(){
    const el = document.getElementById('csvUrlInput');
    if(el && el.value && el.value.trim()) return el.value.trim();
  // Prefer explicit global, otherwise try a repository-relative CSV as a sensible default
  return window.sheetCsvUrl || '../sheet.csv' || '';
  }

  async function loadSheetOptions(){
    if(sheetLoaded) return sheetOptions;
    const url = getSheetUrl();
    if(!url) return sheetOptions;
    try{
      const res = await fetch(url);
      const csv = await res.text();
      sheetOptions = parseCsv(csv);
      sheetLoaded = true;
    }catch(e){
      console.warn('[admin] failed to load sheet CSV', e);
    }
    return sheetOptions;
  }

  function parseCsv(text){
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(lines.length === 0) return [];
    // Detect and skip a header row that contains column names like "Timestamp" or "Book Title"
    const firstCols = splitCsvLine(lines[0]).map(c=> (c||'').toLowerCase());
    let start = 0;
    if(firstCols.some(c => c.includes('timestamp') || c.includes('book') || c.includes('title') || c.includes('author'))){
      start = 1;
    }
    const rows = lines.slice(start).map(l => splitCsvLine(l));
    return rows.map(cols => {
      // Some sheets include a leading timestamp column. Detect date-like entries in cols[0].
      const first = (cols[0]||'').trim();
      const looksLikeTimestamp = /\d{1,4}[\/-]\d{1,2}[\/-]\d{1,4}|\d{1,2}:\d{2}|am|pm/i.test(first);
      const titleIndex = looksLikeTimestamp ? 1 : 0;
      const authorIndex = looksLikeTimestamp ? 2 : 1;
      const sugIndex = looksLikeTimestamp ? 3 : 2;
      const title = (cols[titleIndex]||'').trim();
      const author = (cols[authorIndex]||'').trim();
      const sug = (cols[sugIndex]||'').trim();
      const display = author ? `${title} - ${author}` : title;
      return { title, author, suggestedBy: sug, display, raw: cols };
    }).filter(o => o.title && !/\d{1,2}[\/:]\d{2}/.test(o.title));
  }

  function splitCsvLine(line){
    const res = [];
    let cur = '', inQ = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === '"' ) { inQ = !inQ; continue; }
      if(ch === ',' && !inQ){ res.push(cur); cur=''; continue; }
      cur += ch;
    }
    res.push(cur);
    return res;
  }

  function filterOptions(q){
    if(!q) return sheetOptions.slice(0,50);
    const qq = q.toLowerCase();
    return sheetOptions.filter(o => (o.display||'').toLowerCase().includes(qq) || (o.title||'').toLowerCase().includes(qq)).slice(0,50);
  }

  // Populate the per-panel datalist elements with all unique displays sorted alphabetically
  function populateDatalists(){
    try{
      const lists = Array.from(document.querySelectorAll('.edit-choice-datalist'));
      if(!lists.length) return;
      // Build unique list keyed by display
      const map = new Map();
      sheetOptions.forEach(o => { if(o && o.display) map.set(o.display, o); });
      // Sort alphabetically by book title (not by author portion)
      const all = Array.from(map.values()).sort((a,b)=> (a.title||'').localeCompare(b.title||'', undefined, { sensitivity: 'base' }));
      lists.forEach(dl => {
        // clear existing options
        dl.innerHTML = '';
        all.forEach(opt => {
          const el = document.createElement('option'); el.value = opt.display; dl.appendChild(el);
        });
      });
    }catch(e){ console.warn('populateDatalists failed', e); }
  }

  // Update the datalist for a given panel based on query and return the first match
  function showResults(panel, reelIndex, q){
    const input = panel.querySelector('.edit-choice-input');
    const results = panel.querySelector('.edit-choice-results');
    if(!input || !results) return null;
    const matches = filterOptions(q || '');
  // Sort matches alphabetically by book title (case-insensitive) so dropdown is ordered
  matches.sort((a,b)=> (a.title||'').localeCompare(b.title||'', undefined, { sensitivity: 'base' }));
    // populate styled results list
    results.innerHTML = '';
    if(matches.length === 0){
      results.classList.add('d-none'); results.setAttribute('aria-hidden','true');
      return null;
    }
    matches.forEach(opt => {
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'list-group-item list-group-item-action';
      item.textContent = opt.display;
      item.addEventListener('click', ()=>{ selectOptionForReel(reelIndex, opt, panel); });
      results.appendChild(item);
    });
    results.classList.remove('d-none'); results.setAttribute('aria-hidden','false');
    // If the input value exactly matches one of the displays, prefer that as selected
    const exact = matches.find(m => m.display === input.value);
    return exact || matches[0] || null;
  }

  function selectOptionForReel(reelIndex, opt, panel){
    try{
      // Render markup that matches the slot machine's stopped state: a .slot-scroll-list
      // containing a single .slot-scroll-item. Put the full "Title - Author" string
      // into the reel display and set the Suggested by line below.
      const slotScroll = document.querySelector(`#slot${reelIndex+1} .slot-scroll`);
      // Some rows may have been imported into a single cell ("Title - Author - Suggested By").
      // If the parsed opt.suggestedBy is empty but the display contains 2+ ' - ' segments,
      // treat the last segment as the suggester and render only Title - Author in the reel.
      let display = String(opt.display || '').trim();
      let suggested = (opt.suggestedBy || '').trim();
      if(!suggested){
        const parts = display.split(/\s-\s/);
        if(parts.length >= 3){
          suggested = parts.slice(2).join(' - ').trim();
          display = parts.slice(0,2).join(' - ').trim();
        }
      }
      if(slotScroll){
        slotScroll.innerHTML = `<div class="slot-scroll-list"><div class="slot-scroll-item" style="border-bottom:none">${escapeHtml(display)}</div></div>`;
      }
      const sugEl = document.getElementById(`suggested${reelIndex+1}-name`);
      if(sugEl) sugEl.textContent = suggested || '';

      // Persist selection into slotMachineState so the slot script picks it up
      try{
        let sms = JSON.parse(localStorage.getItem('slotMachineState')||'null');
        if(!Array.isArray(sms)) sms = [null,null,null];
        // store visible Title - Author and suggester for compatibility
        sms[reelIndex] = { book: display, name: suggested || '' };
        localStorage.setItem('slotMachineState', JSON.stringify(sms));
        try{ window.dispatchEvent(new StorageEvent('storage', { key:'slotMachineState', newValue: JSON.stringify(sms) })); }catch(e){}
      }catch(e){}

      // Also keep the older admin slotMachineState shape for backwards compatibility
      try{
        let sms = JSON.parse(localStorage.getItem('slotMachineState')||'null');
        if(Array.isArray(sms) && sms.length > reelIndex){
          // keep admin-era shape but store the visible Title - Author and suggester
          sms[reelIndex] = { book: display, name: suggested || '' };
          localStorage.setItem('slotMachineState', JSON.stringify(sms));
          try{ window.dispatchEvent(new StorageEvent('storage', { key:'slotMachineState', newValue: JSON.stringify(sms) })); }catch(e){}
        }
      }catch(e){}
    }catch(e){ console.warn('replace choice failed', e); }
    panel.classList.add('d-none');
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function initEditChoiceUI(){
    const editBtns = Array.from(document.querySelectorAll('.edit-choice'));
    editBtns.forEach(btn => {
      const idx = Number(btn.getAttribute('data-reel'));
      const panel = document.querySelector(`.edit-choice-panel[data-reel="${idx}"]`);
      const input = panel && panel.querySelector('.edit-choice-input');
      const datalist = panel && panel.querySelector('.edit-choice-datalist');
      btn.addEventListener('click', async ()=>{
        if(!sheetLoaded) await loadSheetOptions();
        panel.classList.toggle('d-none');
        if(!panel.classList.contains('d-none')){
          // populate selects when panel is opened (if options loaded)
          try{ populateDatalists(); }catch(e){}
          showResults(panel, idx, input.value || '');
          input.focus();
        }
      });
      if(input){
        input.addEventListener('input', (ev)=>{ showResults(panel, idx, ev.target.value); });
        input.addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter'){ ev.preventDefault(); const first = showResults(panel, idx, input.value); if(first) selectOptionForReel(idx, first, panel); } });
        // When the input loses focus or changes, if it matches an option exactly, apply it
        input.addEventListener('change', (ev)=>{
          const val = (ev.target && ev.target.value) || '';
          if(!val) return;
          // find matching option object by display
          const opt = sheetOptions.find(o=>o.display === val) || sheetOptions.find(o=>o.title === val) || { display: val, title: val, author: '' };
          if(opt) selectOptionForReel(idx, opt, panel);
        });
  // hide results when input loses focus after a short delay (to allow click)
  input.addEventListener('blur', ()=>{ setTimeout(()=>{ const r = panel.querySelector('.edit-choice-results'); if(r){ r.classList.add('d-none'); r.setAttribute('aria-hidden','true'); } }, 150); });
      }
      // datalist has no change events to select from; selection is handled via input's change/enter handlers above
    });
  }

  // Close any open panels when clicking outside
  document.addEventListener('click', (ev)=>{
    const target = ev.target;
    const isInside = target.closest && (target.closest('.edit-choice-panel') || target.closest('.edit-choice'));
    if(!isInside){
      document.querySelectorAll('.edit-choice-panel').forEach(p=>{ if(!p.classList.contains('d-none')) p.classList.add('d-none'); const r = p.querySelector('.edit-choice-results'); if(r){ r.classList.add('d-none'); r.setAttribute('aria-hidden','true'); } });
    }
  });

  window.showEditChoiceForReel = function(reelIndex){
    try{ const btn = document.querySelector(`.edit-choice[data-reel="${reelIndex}"]`); if(btn) btn.classList.remove('d-none'); }catch(e){}
  };

  document.addEventListener('DOMContentLoaded', ()=>{
    initEditChoiceUI();
    try{
      // On load, reveal edit buttons only when the reel appears to be stopped
      // (the stop button is hidden with .d-none and/or disabled by the slot script when stopped).
      for(let i=1;i<=3;i++){
        const stopBtn = document.getElementById('slotStopBtn'+i);
        const editBtn = document.querySelector(`.edit-choice[data-reel="${i-1}"]`);
  if(stopBtn && stopBtn.classList.contains('d-none') && editBtn){
          editBtn.classList.remove('d-none');
        }
      }
    }catch(e){}

    // Reveal the Edit button for a reel when that reel has been stopped.
    try{
      // Wire stop button clicks: when a reel's Stop button is clicked, show its Edit button
      for(let i=1;i<=3;i++){
        (function(idx){
          const stopBtn = document.getElementById('slotStopBtn'+idx);
          const editBtn = document.querySelector(`.edit-choice[data-reel="${idx-1}"]`);
          if(stopBtn && editBtn){
            stopBtn.addEventListener('click', ()=>{ editBtn.classList.remove('d-none'); });
          }
        })(i);
      }

      // Also reveal when storage updates indicate a reel has a selection (other tabs or scripts)
      window.addEventListener('storage', (ev)=>{
        if(!ev) return;
        try{
          if(ev.key === 'slotMachineState' && ev.newValue){
            const arr = JSON.parse(ev.newValue || 'null') || [];
            arr.forEach((s, idx)=>{
              if(s && (s.book || s.title)){
                const stopBtn = document.getElementById('slotStopBtn'+(idx+1));
                const edit = document.querySelector(`.edit-choice[data-reel="${idx}"]`);
                if(edit && stopBtn && stopBtn.classList.contains('d-none')){
                  edit.classList.remove('d-none');
                }
              }
            });
          }
        }catch(e){}
      });

      // In-window custom event used elsewhere in the app ‚Äî reveal matching edit buttons when pollPublished fires
      window.addEventListener('pollPublished', (ev)=>{
        try{
          const w = (ev && ev.detail) || JSON.parse(localStorage.getItem('pollChoices')||'null') || [];
          w.forEach((s, idx)=>{
            if(s && (s.book || s.title)){
              const stopBtn = document.getElementById('slotStopBtn'+(idx+1));
              const edit = document.querySelector(`.edit-choice[data-reel="${idx}"]`);
              if(edit && stopBtn && stopBtn.classList.contains('d-none')){
                edit.classList.remove('d-none');
              }
            }
          });
        }catch(e){}
      });
    }catch(e){}
    // Attempt to load the published sheet CSV on page load and populate the "choose from all" selects.
    try{
      loadSheetOptions().then(()=>{
        try{ populateDatalists(); }catch(e){}
      }).catch(()=>{/* ignore */});
    }catch(e){}
  });
})();
  </script>
</body>
</html>